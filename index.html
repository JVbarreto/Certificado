<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gerador de Certificado de Pré-Qualificação — Lei nº 14.133/2021</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600;700&family=Source+Sans+3:wght@400;600;700&display=swap" rel="stylesheet" />
    <meta name="description" content="Gerar certificado de pré-qualificação conforme Lei nº 14.133/2021. Salva dados localmente e permite impressão em PDF." />
    <style>
      :root {
        --bg: #0b1020;
        --card: #11162a;
        --muted: #97a1b6;
        --text: #e6ebf5;
        --primary: #4f8cff;
        --primary-600: #2f6ff0;
        --danger: #ff6b6b;
        --ok: #0bb07b;
        --border: #222a45;
        --paper: #ffffff;
        --ink: #1a1a1a;
        --gold: #caa84a;
      }

      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        background: linear-gradient(180deg, #0b1020, #0e1430 60%, #0b1020);
        color: var(--text);
        overflow-x: hidden;
        -webkit-font-smoothing: antialiased;
        text-rendering: optimizeLegibility;
      }

      header {
        padding: 24px 16px 8px;
        text-align: center;
      }
      header h1 {
        margin: 0 0 6px;
        font-size: clamp(18px, 4.2vw, 24px);
        letter-spacing: 0.3px;
      }
      header p {
        margin: 0;
        color: var(--muted);
        font-size: 14px;
      }

      .container {
        max-width: 1050px;
        margin: 16px auto 64px;
        padding: 0 16px 32px;
        background: color-mix(in oklab, var(--card) 94%, transparent);
        border: 1px solid var(--border);
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      }

      .section {
        padding: 20px 16px;
        border-top: 1px dashed var(--border);
      }
      .section:first-of-type { border-top: 0; }
      .section h2 {
        font-size: 16px;
        margin: 0 0 14px;
        color: var(--text);
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 12px;
      }
      .col-12 { grid-column: span 12; }
      .col-9 { grid-column: span 9; }
      .col-8 { grid-column: span 8; }
      .col-6 { grid-column: span 6; }
      .col-4 { grid-column: span 4; }
      .col-3 { grid-column: span 3; }

      @media (max-width: 880px) {
        .grid { grid-template-columns: repeat(6, 1fr); }
        .col-9 { grid-column: span 6; }
        .col-8 { grid-column: span 6; }
        .col-6 { grid-column: span 6; }
        .col-4 { grid-column: span 6; }
        .col-3 { grid-column: span 6; }
      }

      /* Melhorias gerais de quebra para conteúdos longos */
      .cert-grid .value, .certificate a {
        word-break: break-word;
        overflow-wrap: anywhere;
      }

      /* Ajustes para telas pequenas (mobile) */
      @media (max-width: 560px) {
        header { padding: 18px 12px 6px; }
        header h1 { font-size: 20px; }
        header p { font-size: 13px; }

        .container { margin: 12px auto 48px; padding: 0 12px 20px; border-radius: 12px; }
        .section { padding: 16px 12px; }

        .grid { grid-template-columns: 1fr; gap: 10px; }
        .col-12, .col-9, .col-8, .col-6, .col-4, .col-3 { grid-column: span 1; }

        label { font-size: 13px; }
        input[type="text"], input[type="url"], input[type="date"], textarea, select { padding: 12px 14px; font-size: 16px; }

        .file-input { grid-template-columns: 1fr; }
        .logo-preview { width: 64px; height: 64px; margin-bottom: 8px; }

        .actions { flex-direction: column; align-items: stretch; }
        .actions button { width: 100%; }
        .actions button + button { margin-top: 6px; }

        .certificate-wrapper { margin: 20px auto 40px; padding: 0 6px; }
        .certificate { padding: 20px 16px; }
        .cert-header { grid-template-columns: 64px 1fr; gap: 10px; }
        .cert-title { font-size: 20px; }
        .cert-law { font-size: 13px; }

        .cert-grid { grid-template-columns: 1fr; gap: 6px 10px; }
        .cert-grid .item { grid-template-columns: 1fr; gap: 2px; }
        .cert-grid .item .label { color: #555; font-size: 13px; }
        .cert-grid .item .value { word-break: break-word; overflow-wrap: anywhere; }

        .sign { grid-template-columns: 1fr; gap: 16px; }
        .sign .line { margin: 24px 0 6px; }

        .print-actions { flex-direction: column; align-items: stretch; }
        .print-actions button { width: 100%; }

        /* Radios mais clicáveis e empilhados */
        .radio-group { display: grid; grid-template-columns: 1fr; gap: 8px; }
        .radio-group label { padding: 10px 12px; border: 1px solid var(--border); border-radius: 12px; background: #0f1530; }
        .radio-group input[type="radio"] { transform: scale(1.15); }

        .cert-seal { position: static; width: 92px; height: 92px; margin: 12px auto 0; }
      }

      label {
        display: block;
        font-size: 13px;
        color: var(--muted);
        margin: 6px 0 6px 2px;
      }
      input[type="text"], input[type="url"], input[type="date"], textarea, select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border);
        background: #0f1530;
        color: var(--text);
        border-radius: 10px;
        outline: none;
        transition: 0.2s border, 0.2s box-shadow;
      }
      textarea { min-height: 80px; resize: vertical; }
      input::placeholder, textarea::placeholder { color: #7884a4; }
      input:focus, textarea:focus, select:focus {
        border-color: color-mix(in oklab, var(--primary) 70%, white);
        box-shadow: 0 0 0 3px rgba(79, 140, 255, 0.2);
      }

      .file-input {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 12px;
        align-items: center;
        padding: 10px;
        border: 1px dashed var(--border);
        border-radius: 10px;
        background: #0f1530;
      }
      .file-input input[type="file"] { width: 100%; }
      .logo-preview { width: 72px; height: 72px; border-radius: 8px; background: #0b1022; border: 1px solid var(--border); display: grid; place-items: center; overflow: hidden; }
      .logo-preview img { max-width: 100%; max-height: 100%; object-fit: contain; }

      .radio-group { display: flex; gap: 16px; flex-wrap: wrap; }
      .radio-group label { margin: 0; display: inline-flex; align-items: center; gap: 6px; }

      .actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 8px; }
      button {
        background: var(--primary);
        border: 1px solid color-mix(in oklab, var(--primary) 90%, black);
        color: white;
        padding: 10px 14px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        letter-spacing: 0.2px;
        transition: 0.15s transform, 0.15s background, 0.15s opacity;
        min-height: 44px; /* alvo de toque */
      }
      button:hover { background: var(--primary-600); }
      button.secondary { background: transparent; color: var(--text); border-color: var(--border); }
      button.ghost { background: transparent; color: var(--muted); border-color: transparent; }
      button.danger { background: var(--danger); border-color: #e85a5a; }
      button:disabled { opacity: 0.6; cursor: not-allowed; }

      .helper {
        color: var(--muted);
        font-size: 12px;
        margin-top: 4px;
      }

      .error {
        color: var(--danger);
        font-size: 13px;
        margin: 8px 0 0;
      }

      /* Certificado (modo visualização/print) */
      .certificate-wrapper {
        display: none;
        margin: 32px auto 64px;
        max-width: 900px;
      }
      .certificate {
        background: var(--paper);
        color: var(--ink);
        position: relative;
        border-radius: 10px;
        padding: clamp(16px, 4.2vw, 36px) clamp(16px, 4.8vw, 40px);
        box-shadow: 0 12px 40px rgba(0,0,0,0.25);
        font-family: "Source Sans 3", system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell;
      }
      .certificate::before, .certificate::after {
        content: "";
        position: absolute;
        inset: 8px;
        border: 1.5px solid rgba(0,0,0,0.08);
        border-radius: 8px;
        pointer-events: none;
      }
      .certificate::after {
        inset: 16px;
        border: 2px solid color-mix(in oklab, var(--gold) 80%, #b7924d);
        border-radius: 6px;
        opacity: 0.9;
      }
      .cert-header { display: grid; grid-template-columns: 96px 1fr; gap: 16px; align-items: center; margin-bottom: 12px; }
      .cert-header .cert-logo { width: 96px; height: 96px; border: 1px solid #eee; border-radius: 8px; overflow: hidden; display: grid; place-items: center; background: #fafafa; }
      .cert-header .cert-logo img { max-width: 100%; max-height: 100%; object-fit: contain; }
      .cert-header h3 { margin: 0; font-size: clamp(18px, 4.2vw, 20px); line-height: 1.35; font-weight: 700; font-family: "Cormorant Garamond", serif; letter-spacing: 0.2px; }
      .cert-sub { color: #565656; margin: 2px 0 18px; font-size: 13px; }

      .cert-title {
        text-align: center;
        font-size: clamp(22px, 5.4vw, 32px);
        font-weight: 700;
        font-family: "Cormorant Garamond", serif;
        margin: 10px 0 8px;
        text-transform: uppercase;
        letter-spacing: 1.2px;
        color: #1a1a1a;
      }
      .cert-title::after {
        content: "";
        display: block;
        width: 120px; height: 2px;
        margin: 8px auto 0;
        background: linear-gradient(90deg, transparent, color-mix(in oklab, var(--gold) 85%, #b7924d), transparent);
      }
      .cert-law { text-align: center; color: #444; font-size: clamp(12px, 3.5vw, 14px); margin: 6px 0 16px; letter-spacing: 0.3px; }

      .cert-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 8px 16px; margin-top: 8px; }
      .cert-grid .item { display: grid; grid-template-columns: minmax(140px, 220px) 1fr; gap: 8px; align-items: baseline; }
      .cert-grid .item .label { color: #555; font-weight: 600; }
      .cert-grid .item .value { font-weight: 600; color: #111; }

      .cert-block { margin-top: 16px; padding-top: 10px; border-top: 1px dashed #e2e2e2; }
      .cert-block p { margin: 6px 0; }

      .sign {
        margin-top: 24px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
      }
      .sign .slot { text-align: center; }
      .sign .line { margin: 32px 0 6px; height: 1px; background: #333; opacity: 0.8; }
      .sign .name { font-weight: 700; font-family: "Cormorant Garamond", serif; font-size: 16px; letter-spacing: 0.3px; }
      .sign .role { color: #444; font-size: 14px; }

      .print-actions { display: flex; gap: 10px; justify-content: flex-end; margin: 12px 0 8px; }

      footer { text-align: center; color: var(--muted); font-size: 12px; padding: 24px 12px; }

      /* Selo decorativo */
      .cert-seal {
        position: absolute;
        right: 24px;
        bottom: 28px;
        width: 108px;
        height: 108px;
        border: 3px solid color-mix(in oklab, var(--gold) 85%, #b7924d);
        border-radius: 50%;
        color: color-mix(in oklab, var(--gold) 85%, #b7924d);
        display: grid; place-items: center;
        text-align: center;
        font-family: "Cormorant Garamond", serif;
        font-weight: 700;
        letter-spacing: 0.6px;
      }
      .cert-seal span { display: block; font-size: 11px; text-transform: uppercase; }
      .cert-seal strong { display: block; font-size: 14px; }

      @media print {
        html, body { background: var(--paper) !important; height: auto; overflow: visible; }
        header, .container, .actions, .print-hide, footer { display: none !important; }
        .certificate-wrapper { display: block !important; margin: 0; padding: 0; }
        .certificate {
          box-shadow: none; border: 0;
          width: 100%; max-width: 190mm; margin: 0 auto;
          padding: 12mm;
          -webkit-print-color-adjust: exact; print-color-adjust: exact;
          font-size: 11pt; line-height: 1.45;
        }
        .cert-header, .cert-block, .sign, .cert-grid .item { break-inside: avoid; page-break-inside: avoid; }
        .cert-title { font-size: 16pt; }
        .cert-law { font-size: 10pt; }
        .cert-header h3 { font-size: 12pt; }
        .cert-grid { grid-template-columns: 1fr; gap: 6pt 10pt; }
        .cert-grid .item { grid-template-columns: 1fr; gap: 2pt; }
        .sign { grid-template-columns: 1fr 1fr; gap: 16pt; }
        @page { size: A4; margin: 12mm; }
        a[href]:after { content: " (" attr(href) ")"; font-size: 9pt; color: #666; }
        .cert-seal { right: 18mm; bottom: 18mm; width: 28mm; height: 28mm; border-width: 2px; font-size: 10pt; }
      }

      /* Classe utilitária para captura offscreen (se for usada) */
      .capture-context .certificate { background: #ffffff; color: #000000; }
    </style>
  </head>
  <body>
    <header>
      <h1>Gerador de Certificado de Pré-Qualificação</h1>
      <p>Preencha os campos abaixo para gerar o certificado conforme a Lei nº 14.133/2021. Pode ser atualizado a qualquer tempo.</p>
    </header>

    <main class="container print-hide" role="main">
      <form id="formCert" novalidate>
        <div id="formError" class="error" style="display:none"></div>

        <section class="section">
          <h2>1. Dados de Identificação</h2>
          <div class="grid">
            <div class="col-9">
              <label for="orgao">Órgão / Entidade Emissora</label>
              <input id="orgao" name="orgao" type="text" placeholder="Ex.: Secretaria Municipal de Administração" required />
            </div>
            <div class="col-3">
              <label for="logo">Logomarca do Município/Órgão (Opcional)</label>
              <div class="file-input">
                <div class="logo-preview" aria-label="Pré-visualização da logomarca">
                  <span style="font-size:11px;color:#6b7280">Sem logo</span>
                </div>
                <input id="logo" name="logo" type="file" accept="image/*" />
              </div>
              <div class="actions" style="justify-content:flex-start;margin-top:8px">
                <button type="button" class="secondary" id="removerLogo">Remover</button>
              </div>
            </div>

            <div class="col-6">
              <label for="processo">Nº do Processo Administrativo</label>
              <input id="processo" name="processo" type="text" placeholder="Ex.: 000123/2025" required />
            </div>
            <div class="col-6">
              <label for="edital">Nº do Edital de Pré-Qualificação</label>
              <input id="edital" name="edital" type="text" placeholder="Opcional" />
            </div>

            <div class="col-12">
              <label for="regulamentacao">Regulamentação Municipal (Decreto, etc.)</label>
              <input id="regulamentacao" name="regulamentacao" type="text" placeholder="Ex.: Decreto Municipal nº 1.234/2023 (se houver)" />
            </div>
          </div>
        </section>

        <section class="section">
          <h2>2. Objeto e Escopo da Qualificação</h2>
          <div class="grid">
            <div class="col-6">
              <label>Natureza da Pré-Qualificação</label>
              <div class="radio-group" role="radiogroup" aria-label="Natureza da Pré-Qualificação">
                <label><input type="radio" name="natureza" value="Subjetiva (de Licitante)" required /> Subjetiva (de Licitante)</label>
                <label><input type="radio" name="natureza" value="Objetiva (de Bem)" /> Objetiva (de Bem)</label>
              </div>
            </div>
            <div class="col-6">
              <label>Âmbito da Abrangência (Art. 80, § 7º)</label>
              <div class="radio-group" role="radiogroup" aria-label="Abrangência da Qualificação">
                <label><input type="radio" name="abrangencia" value="Total" required /> Total</label>
                <label><input type="radio" name="abrangencia" value="Parcial" /> Parcial</label>
              </div>
            </div>

            <div class="col-6">
              <label for="razao">Razão Social</label>
              <input id="razao" name="razao" type="text" placeholder="Ex.: ACME Serviços Ltda." required />
            </div>
            <div class="col-6">
              <label for="cnpj">CNPJ</label>
              <input id="cnpj" name="cnpj" type="text" inputmode="numeric" placeholder="00.000.000/0000-00" maxlength="18" required />
              <div class="helper">Informe um CNPJ válido (14 dígitos).</div>
            </div>

            <div class="col-12">
              <label for="segmento">Segmento ou Especialidade da Qualificação</label>
              <textarea id="segmento" name="segmento" placeholder="Descreva a especialidade, linhas de fornecimento, itens ou escopo de pré-qualificação (se aplicável)"></textarea>
            </div>
          </div>
        </section>

        <section class="section">
          <h2>3. Validade e Formalização</h2>
          <div class="grid">
            <div class="col-4">
              <label for="inicio">Início da Validade</label>
              <input id="inicio" name="inicio" type="date" required />
            </div>
            <div class="col-4">
              <label for="fim">Fim da Validade</label>
              <input id="fim" name="fim" type="date" required />
              <div class="helper">Máximo de 1 ano e não superior à validade dos documentos apresentados.</div>
            </div>
            <div class="col-4">
              <label for="local">Local de Emissão</label>
              <input id="local" name="local" type="text" placeholder="Ex.: Fortaleza/CE" required />
            </div>

            <div class="col-6">
              <label for="autor">Autoridade Competente (Nome)</label>
              <input id="autor" name="autor" type="text" placeholder="Nome completo" required />
            </div>
            <div class="col-6">
              <label for="cargo">Cargo da Autoridade</label>
              <input id="cargo" name="cargo" type="text" placeholder="Ex.: Secretário(a) Municipal de Administração" required />
            </div>

            <div class="col-6">
              <label for="linkPublico">Link para Consulta Pública</label>
              <input id="linkPublico" name="linkPublico" type="url" placeholder="https://..." />
            </div>
            <div class="col-6">
              <label for="linkPncp">Link para lista de pré-qualificados (PNCP ou site oficial)</label>
              <input id="linkPncp" name="linkPncp" type="url" placeholder="https://..." />
            </div>
          </div>
        </section>

        <div class="section actions">
          <button type="submit" id="btnGerar">Gerar Certificado</button>
          <button type="button" class="secondary" id="btnSalvar">Salvar dados</button>
          <button type="button" class="ghost" id="btnLimpar">Limpar dados</button>
        </div>
      </form>
    </main>

    <section id="certWrapper" class="certificate-wrapper">
      <div class="print-actions print-hide">
        <button type="button" id="btnEditar" class="secondary">Editar dados</button>
        <button type="button" id="btnImprimir">Imprimir</button>
        <button type="button" id="btnBaixarPdf">Baixar PDF</button>
      </div>
      <article class="certificate" aria-label="Certificado de Pré-Qualificação" id="certificado">
        <div class="cert-header">
          <div class="cert-logo" id="certLogo"></div>
          <div>
            <h3 id="certOrgao">Órgão / Entidade Emissora</h3>
            <p class="cert-sub" id="certSubhead"></p>
          </div>
        </div>
        <div class="cert-title">Certificado de Pré-Qualificação</div>
        <div class="cert-law">Conforme Lei nº 14.133/2021</div>

        <div class="cert-block">
          <p id="certDeclaracao"></p>
        </div>

        <div class="cert-block">
          <div class="cert-grid">
            <div class="item"><div class="label">Processo Administrativo:</div><div class="value" id="valProcesso"></div></div>
            <div class="item"><div class="label">Edital de Pré-Qualificação:</div><div class="value" id="valEdital"></div></div>
            <div class="item"><div class="label">Regulamentação Municipal:</div><div class="value" id="valRegulamentacao"></div></div>
            <div class="item"><div class="label">Natureza:</div><div class="value" id="valNatureza"></div></div>
            <div class="item"><div class="label">Abrangência:</div><div class="value" id="valAbrangencia"></div></div>
            <div class="item" style="grid-column:1/-1"><div class="label">Segmento / Especialidade:</div><div class="value" id="valSegmento"></div></div>
            <div class="item"><div class="label">Início da Validade:</div><div class="value" id="valInicio"></div></div>
            <div class="item"><div class="label">Fim da Validade:</div><div class="value" id="valFim"></div></div>
            <div class="item"><div class="label">Local de Emissão:</div><div class="value" id="valLocal"></div></div>
          </div>
        </div>

        <div class="cert-block" id="linksBloco" style="display:none">
          <p>Consulta pública: <a id="valLinkPublico" href="#" target="_blank" rel="noopener noreferrer"></a></p>
          <p>Lista de pré-qualificados: <a id="valLinkPncp" href="#" target="_blank" rel="noopener noreferrer"></a></p>
        </div>

        <div class="sign">
          <div class="slot">
            <div class="line"></div>
            <div class="name" id="valAutor"></div>
            <div class="role" id="valCargo"></div>
          </div>
          <div class="slot">
            <div class="line"></div>
            <div class="name">Reconhecimento/Carimbo (se aplicável)</div>
            <div class="role">—</div>
          </div>
        </div>

        <div class="cert-block" style="font-size:12px;color:#444">
          <p>Este certificado poderá ser atualizado a qualquer tempo. A validade aqui registrada não poderá exceder 1 (um) ano nem ultrapassar a validade dos documentos apresentados.</p>
        </div>
        <div class="cert-seal"><span>Pré</span><strong>Qualificado</strong></div>
      </article>
    </section>

    <footer class="print-hide">
      Desenvolvido por: <strong>Vitor Barreto</strong>
    </footer>

  <script>
      // Carrega html2pdf.js sob demanda e garante apenas um carregamento
      function ensureHtml2PdfLoaded() {
        if (window.html2pdf) return Promise.resolve();
        if (window.__html2pdfPromise) return window.__html2pdfPromise;
        window.__html2pdfPromise = new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
          script.onload = () => resolve();
          script.onerror = () => reject(new Error('Falha ao carregar html2pdf.js'));
          document.head.appendChild(script);
        });
        return window.__html2pdfPromise;
      }
      const STORAGE_KEY = "cert_pre_qualificacao_dados_v1";

      function byId(id) { return document.getElementById(id); }
      function getRadioValue(name) {
        const input = document.querySelector(`input[name="${name}"]:checked`);
        return input ? input.value : "";
      }
      function setRadioValue(name, value) {
        const input = document.querySelector(`input[name="${name}"][value="${value}"]`);
        if (input) input.checked = true;
      }
      function onlyDigits(value) { return (value || "").replace(/\D+/g, ""); }
      function formatCnpj(raw) {
        const digits = onlyDigits(raw).slice(0, 14);
        const parts = [];
        if (digits.length > 0) parts.push(digits.slice(0, 2));
        if (digits.length > 2) parts.push(digits.slice(2, 5));
        if (digits.length > 5) parts.push(digits.slice(5, 8));
        let suffix = "";
        if (digits.length > 8) suffix = digits.slice(8, 12) + (digits.length > 12 ? "-" + digits.slice(12, 14) : "");
        const main = parts.join(".");
        return main + (digits.length > 8 ? "/" + suffix : "");
      }
      function isValidCnpj(raw) {
        const digits = onlyDigits(raw);
        if (digits.length !== 14) return false;
        // Validação básica (comprimento) + rejeita repetidos
        if (/^(\d)\1{13}$/.test(digits)) return false;
        // Cálculo dos dígitos verificadores
        const calc = (base) => {
          let size = base.length;
          let numbers = base.split("");
          let sum = 0;
          let pos = size - 7;
          for (let i = size; i >= 1; i--) {
            sum += parseInt(numbers[size - i], 10) * pos--;
            if (pos < 2) pos = 9;
          }
          let result = sum % 11 < 2 ? 0 : 11 - (sum % 11);
          return result;
        };
        const base12 = digits.substring(0, 12);
        const d1 = calc(base12);
        const d2 = calc(base12 + d1);
        return digits.endsWith(String(d1) + String(d2));
      }

      function formatDateBR(isoDate) {
        if (!isoDate) return "";
        const [y, m, d] = isoDate.split("-").map(Number);
        if (!y || !m || !d) return "";
        return String(d).padStart(2, "0") + "/" + String(m).padStart(2, "0") + "/" + y;
      }
      function parseISO(dateStr) { return dateStr ? new Date(dateStr + "T00:00:00") : null; }
      function addDays(date, days) { const d = new Date(date); d.setDate(d.getDate() + days); return d; }
      function toISODate(date) { return date.toISOString().slice(0, 10); }

      function showError(msg) {
        const el = byId("formError");
        el.textContent = msg;
        el.style.display = msg ? "block" : "none";
      }

      function collectForm() {
        return {
          orgao: byId("orgao").value.trim(),
          processo: byId("processo").value.trim(),
          edital: byId("edital").value.trim(),
          regulamentacao: byId("regulamentacao").value.trim(),
          natureza: getRadioValue("natureza"),
          abrangencia: getRadioValue("abrangencia"),
          razao: byId("razao").value.trim(),
          cnpj: byId("cnpj").value.trim(),
          segmento: byId("segmento").value.trim(),
          inicio: byId("inicio").value,
          fim: byId("fim").value,
          local: byId("local").value.trim(),
          autor: byId("autor").value.trim(),
          cargo: byId("cargo").value.trim(),
          linkPublico: byId("linkPublico").value.trim(),
          linkPncp: byId("linkPncp").value.trim(),
          logoDataUrl: byId("logo").dataset.preview || ""
        };
      }

      function validateData(data) {
        // Campos obrigatórios
        const required = [
          ["orgao", "Informe o órgão/entidade emissora."],
          ["processo", "Informe o número do processo administrativo."],
          ["natureza", "Selecione a natureza da pré-qualificação."],
          ["abrangencia", "Selecione a abrangência (Total ou Parcial)."],
          ["razao", "Informe a razão social."],
          ["cnpj", "Informe o CNPJ."],
          ["inicio", "Informe a data de início da validade."],
          ["fim", "Informe a data de fim da validade."],
          ["local", "Informe o local de emissão."],
          ["autor", "Informe o nome da autoridade competente."],
          ["cargo", "Informe o cargo da autoridade."],
        ];
        for (const [key, message] of required) {
          if (!data[key]) return message;
        }

        // CNPJ válido
        if (!isValidCnpj(data.cnpj)) return "CNPJ inválido. Verifique os dígitos informados.";

        // Datas e limites de validade
        const dInicio = parseISO(data.inicio);
        const dFim = parseISO(data.fim);
        if (!dInicio || !dFim) return "Datas de validade inválidas.";
        if (dFim < dInicio) return "A data de fim não pode ser anterior ao início.";
        const maxFim = addDays(dInicio, 365); // máximo 1 ano
        if (dFim > maxFim) return "A validade máxima é de 1 ano a partir da data de início.";
        return "";
      }

      function saveToStorage(data) {
        try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch (_) {}
      }
      function loadFromStorage() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          return raw ? JSON.parse(raw) : null;
        } catch (_) { return null; }
      }
      function clearStorage() { try { localStorage.removeItem(STORAGE_KEY); } catch (_) {} }

      function fillForm(data) {
        if (!data) return;
        byId("orgao").value = data.orgao || "";
        byId("processo").value = data.processo || "";
        byId("edital").value = data.edital || "";
        byId("regulamentacao").value = data.regulamentacao || "";
        if (data.natureza) setRadioValue("natureza", data.natureza);
        if (data.abrangencia) setRadioValue("abrangencia", data.abrangencia);
        byId("razao").value = data.razao || "";
        byId("cnpj").value = formatCnpj(data.cnpj || "");
        byId("segmento").value = data.segmento || "";
        byId("inicio").value = data.inicio || "";
        byId("fim").value = data.fim || "";
        byId("local").value = data.local || "";
        byId("autor").value = data.autor || "";
        byId("cargo").value = data.cargo || "";
        byId("linkPublico").value = data.linkPublico || "";
        byId("linkPncp").value = data.linkPncp || "";
        if (data.logoDataUrl) setLogoPreview(data.logoDataUrl);
      }

      function setLogoPreview(dataUrl) {
        const previewBox = document.querySelector('.logo-preview');
        const certLogo = byId('certLogo');
        const fileInput = byId('logo');
        previewBox.innerHTML = dataUrl ? `<img alt="Logomarca" src="${dataUrl}" />` : '<span style="font-size:11px;color:#6b7280">Sem logo</span>';
        certLogo.innerHTML = dataUrl ? `<img alt="Logomarca" src="${dataUrl}" />` : '';
        if (dataUrl) fileInput.dataset.preview = dataUrl; else delete fileInput.dataset.preview;
      }

      function generateCertificate(data) {
        // Cabeçalho
        byId('certOrgao').textContent = data.orgao || '';
        const periodo = `${formatDateBR(data.inicio)} a ${formatDateBR(data.fim)}`;
        byId('certSubhead').textContent = `Validade: ${periodo}`;

        // Declaração principal
        const partes = [];
        partes.push(`Certificamos que a empresa ${data.razao}, inscrita no CNPJ nº ${formatCnpj(data.cnpj)}, foi pré-qualificada no âmbito desta Administração, na natureza ${data.natureza}${data.abrangencia ? `, com abrangência ${data.abrangencia.toLowerCase()}` : ''}.`);
        if (data.segmento) partes.push(`Segmento/Especialidade: ${data.segmento}.`);
        partes.push(`Este certificado é emitido com base no Processo Administrativo nº ${data.processo}${data.edital ? `, Edital de Pré-Qualificação nº ${data.edital}` : ''}${data.regulamentacao ? ` e na regulamentação municipal ${data.regulamentacao}` : ''}.`);
        partes.push(`Local e data de emissão: ${data.local}, ${formatDateBR(data.inicio)}.`);
        byId('certDeclaracao').textContent = partes.join(' ');

        // Campos
        byId('valProcesso').textContent = data.processo || '-';
        byId('valEdital').textContent = data.edital || '-';
        byId('valRegulamentacao').textContent = data.regulamentacao || '-';
        byId('valNatureza').textContent = data.natureza || '-';
        byId('valAbrangencia').textContent = data.abrangencia || '-';
        byId('valSegmento').textContent = data.segmento || '-';
        byId('valInicio').textContent = formatDateBR(data.inicio) || '-';
        byId('valFim').textContent = formatDateBR(data.fim) || '-';
        byId('valLocal').textContent = data.local || '-';
        byId('valAutor').textContent = data.autor || '';
        byId('valCargo').textContent = data.cargo || '';

        // Links
        const hasPublic = !!data.linkPublico;
        const hasPncp = !!data.linkPncp;
        const showLinks = hasPublic || hasPncp;
        byId('linksBloco').style.display = showLinks ? 'block' : 'none';
        if (hasPublic) {
          byId('valLinkPublico').textContent = data.linkPublico;
          byId('valLinkPublico').href = data.linkPublico;
        }
        if (hasPncp) {
          byId('valLinkPncp').textContent = data.linkPncp;
          byId('valLinkPncp').href = data.linkPncp;
        }

        // Logo
        setLogoPreview(data.logoDataUrl || '');

        // Mostrar certificado
        byId('certWrapper').style.display = 'block';
        // Rolar até o certificado
        setTimeout(() => {
          byId('certWrapper').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 50);
      }

      function updateFimMinMax() {
        const inicio = byId('inicio').value;
        const fim = byId('fim');
        if (!inicio) { fim.min = ''; fim.max = ''; return; }
        const dInicio = parseISO(inicio);
        const min = toISODate(dInicio);
        const max = toISODate(addDays(dInicio, 365));
        fim.min = min;
        fim.max = max;
        if (fim.value && (fim.value < min || fim.value > max)) fim.value = '';
      }

      document.addEventListener('DOMContentLoaded', () => {
        async function generatePdfFromCertificate() {
          await ensureHtml2PdfLoaded();
          const source = byId('certificado');
          if (!source) return;

          // Clona o certificado e renderiza offscreen para evitar piscar a UI
          const wrapper = document.createElement('div');
          wrapper.style.position = 'fixed';
          wrapper.style.left = '-10000px';
          wrapper.style.top = '0';
          wrapper.style.width = '210mm';
          wrapper.style.background = '#ffffff';
          const clone = source.cloneNode(true);
          // Garante fundo branco e texto escuro no clone
          clone.style.background = '#ffffff';
          clone.style.color = '#000000';
          wrapper.appendChild(clone);
          document.body.appendChild(wrapper);

          var orgaoText = 'certificado';
          var orgaoEl = byId('certOrgao');
          if (orgaoEl && typeof orgaoEl.textContent === 'string') { orgaoText = orgaoEl.textContent; }
          const orgao = String(orgaoText)
            .replace(/[^a-zA-Z0-9 _-]+/g, '')
            .slice(0, 60);

          const isSmallScreen = Math.min(window.innerWidth, window.innerHeight) < 600;
          const scaleValue = isSmallScreen ? 1.0 : Math.min(1.4, window.devicePixelRatio || 1.2);
          const opt = {
            margin: [10, 10, 12, 10],
            filename: `Certificado-${orgao}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: {
              scale: scaleValue,
              useCORS: true,
              scrollX: 0,
              scrollY: 0,
              backgroundColor: '#ffffff'
            },
            pagebreak: { mode: ['css', 'legacy'], avoid: ['.cert-header', '.cert-block', '.sign', '.item'] },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
          };

          try {
            // pequena pausa para o layout do clone estabilizar
            await new Promise(r => setTimeout(r, 150));
            const worker = window.html2pdf().from(clone).set(opt).toPdf();
            const pdf = await worker.get('pdf');
            const blob = pdf.output('blob');
            const blobUrl = URL.createObjectURL(blob);
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !(window).MSStream;
            if (isIOS) {
              window.open(blobUrl, '_blank');
            } else {
              const a = document.createElement('a');
              a.href = blobUrl;
              a.download = `Certificado-${orgao}.pdf`;
              document.body.appendChild(a);
              a.click();
              a.remove();
              setTimeout(() => URL.revokeObjectURL(blobUrl), 2000);
            }
          } finally {
            wrapper.remove();
          }
        }
        // Carregar dados
        const saved = loadFromStorage();
        if (saved) fillForm(saved);
        updateFimMinMax();

        // Máscara/validação de CNPJ
        const cnpjInput = byId('cnpj');
        cnpjInput.addEventListener('input', () => { cnpjInput.value = formatCnpj(cnpjInput.value); });

        // Datas
        byId('inicio').addEventListener('change', updateFimMinMax);

        // Upload de logomarca
        const fileInput = byId('logo');
        fileInput.addEventListener('change', (ev) => {
          const file = ev.target.files && ev.target.files[0];
          if (!file) { setLogoPreview(''); return; }
          if (!file.type.startsWith('image/')) { alert('Selecione um arquivo de imagem.'); return; }
          const reader = new FileReader();
          reader.onload = (e) => { setLogoPreview(String(e.target.result)); };
          reader.readAsDataURL(file);
        });
        byId('removerLogo').addEventListener('click', () => {
          fileInput.value = '';
          setLogoPreview('');
        });

        // Ações
        byId('btnSalvar').addEventListener('click', () => {
          const data = collectForm();
          const err = validateData({ ...data, cnpj: data.cnpj || cnpjInput.value });
          if (err) { showError(err); return; }
          saveToStorage(data);
          showError('');
          alert('Dados salvos com sucesso neste dispositivo.');
        });

        byId('btnLimpar').addEventListener('click', () => {
          if (!confirm('Deseja limpar todos os dados salvos?')) return;
          clearStorage();
          document.getElementById('formCert').reset();
          setLogoPreview('');
          showError('');
        });

        byId('formCert').addEventListener('submit', (e) => {
          e.preventDefault();
          const data = collectForm();
          const err = validateData(data);
          if (err) { showError(err); return; }
          showError('');
          saveToStorage(data);
          generateCertificate(data);
        });

        byId('btnEditar').addEventListener('click', () => {
          byId('certWrapper').style.display = 'none';
          document.querySelector('.container').scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
        byId('btnImprimir').addEventListener('click', () => window.print());
        byId('btnBaixarPdf').addEventListener('click', async () => {
          btnBaixarPdf.disabled = true;
          try {
            await generatePdfFromCertificate();
          } catch (e) {
            console.error(e);
            try { window.print(); } catch (_) {}
            alert('Não foi possível gerar o PDF diretamente. Use a opção Imprimir e selecione "Salvar como PDF".');
          } finally {
            btnBaixarPdf.disabled = false;
          }
        });
      });
    </script>
  </body>
</html>


